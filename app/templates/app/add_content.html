{% extends "app/base.html" %}
{% block title %}Добавить контент{% endblock %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Добавить новый контент</h2>
    <form method="post" enctype="multipart/form-data" class="mt-4">
        {% csrf_token %}
        
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="form-group">
                    {{ form.search_title.label_tag }}
                    <div class="input-group">
                        {{ form.search_title }}
                        <div class="input-group-append">
                            <button type="button" class="btn btn-primary" id="search-content">Поиск</button>
                        </div>
                    </div>
                    <small class="form-text text-muted">Введите название фильма или сериала для автоматического заполнения информации</small>
                </div>
                <div class="form-group">
                    {{ form.content_type.label_tag }}
                    <div class="form-check form-check-inline">
                        {{ form.content_type }}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    {{ form.title.label_tag }}
                    {{ form.title }}
                </div>
                <div class="form-group">
                    {{ form.genre.label_tag }}
                    {{ form.genre }}
                </div>
                <div class="form-group">
                    {{ form.category.label_tag }}
                    {{ form.category }}
                </div>
                <div class="form-group">
                    {{ form.status.label_tag }}
                    {{ form.status }}
                </div>
                <div class="form-group">
                    {{ form.rating.label_tag }}
                    {{ form.rating }}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    {{ form.release_year.label_tag }}
                    {{ form.release_year }}
                </div>
                <div class="form-group">
                    {{ form.country.label_tag }}
                    {{ form.country }}
                </div>
                <div class="form-group">
                    {{ form.director.label_tag }}
                    {{ form.director }}
                </div>
                <div class="form-group">
                    {{ form.actor.label_tag }}
                    {{ form.actor }}
                </div>
                <div class="form-group">
                    {{ form.image.label_tag }}
                    {{ form.image }}
                    <div id="poster-preview" class="mt-2"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="form-group">
                    {{ form.description.label_tag }}
                    {{ form.description }}
                </div>
                <div class="form-group">
                    {{ form.comment.label_tag }}
                    {{ form.comment }}
                </div>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <a href="{% url 'home' %}" class="btn btn-secondary">Отмена</a>
        </div>
    </form>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchButton = document.getElementById('search-content');
    const searchInput = document.getElementById('content-search');
    const contentTypeInputs = document.querySelectorAll('input[name="content_type"]');
    
    searchButton.addEventListener('click', function() {
        const title = searchInput.value.trim();
        if (!title) {
            alert('Пожалуйста, введите название фильма или сериала');
            return;
        }

        // Получаем выбранный тип контента
        let contentType = 'movie';
        contentTypeInputs.forEach(input => {
            if (input.checked) {
                contentType = input.value;
            }
        });

        // Показываем индикатор загрузки
        searchButton.disabled = true;
        searchButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Поиск...';

        // Отправляем запрос к API
        fetch(`/api/search-content/?title=${encodeURIComponent(title)}&type=${contentType}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Заполняем форму полученными данными
                document.getElementById('id_title').value = data.title || '';
                document.getElementById('id_description').value = data.description || '';
                document.getElementById('id_release_year').value = data.release_year || '';
                document.getElementById('id_country').value = data.country || '';
                document.getElementById('id_director').value = data.director || '';
                document.getElementById('id_actor').value = data.actors || '';
                
                if (data.rating) {
                    document.getElementById('id_rating').value = parseFloat(data.rating);
                }

                // Если есть постер, показываем его
                if (data.poster_path) {
                    const posterPreview = document.getElementById('poster-preview');
                    posterPreview.innerHTML = `
                        <img src="${data.poster_path}" class="img-thumbnail" style="max-height: 200px;">
                        <input type="hidden" name="poster_path" value="${data.poster_path}">
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка при поиске контента');
            })
            .finally(() => {
                // Восстанавливаем кнопку
                searchButton.disabled = false;
                searchButton.innerHTML = 'Поиск';
            });
    });
});
</script>
{% endblock %}
{% endblock %} 